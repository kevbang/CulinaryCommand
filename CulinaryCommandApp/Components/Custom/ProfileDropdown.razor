@using CulinaryCommand.Services
@using CulinaryCommand.Services.UserContextSpace
@inject IUserContextService UserCtx
@inject NavigationManager Nav
@rendermode InteractiveServer

<div class="dropdown">
    <button class="btn btn-light dropdown-toggle d-flex align-items-center py-2 px-3"
            type="button"
            id="profileMenu"
            data-bs-toggle="dropdown"
            aria-expanded="false"
            style="height:3rem;"
            title="Profile">
        <img src="images/profile.jpg"
             alt="Profile"
             class="rounded-circle me-2"
             style="width:2.5rem; height:2.5rem;" />

        <div class="text-start">
            <div class="fw-semibold">@UserEmail</div>
            <small class="text-muted">@UserRole</small>
        </div>
    </button>

    <ul class="dropdown-menu dropdown-menu-end shadow-lg" aria-labelledby="profileMenu">
        <li><h6 class="dropdown-header">@CompanyName</h6></li>
        <li><a class="dropdown-item" href="/profile">View Profile</a></li>
        <li><a class="dropdown-item" href="/settings">Settings</a></li>
        <li><hr class="dropdown-divider" /></li>
        <li>
            <button class="dropdown-item text-danger fw-semibold" @onclick="Logout">
                <i class="bi bi-box-arrow-right me-2"></i> Logout
            </button>
        </li>
    </ul>
</div>

@code {
    private string UserEmail = "Guest";
    private string UserRole = "";
    private string CompanyName = "";

    protected override async Task OnInitializedAsync()
    {
        var ctx = await UserCtx.GetAsync();
        UserEmail = string.IsNullOrWhiteSpace(ctx.Email) ? "Guest" : ctx.Email;
        UserRole = ctx.User?.Role ?? "";
        CompanyName = ctx.User?.Company?.Name ?? "";
    }

    private bool _loaded;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender || _loaded) return;
        _loaded = true;

        var ctx = await UserCtx.RefreshAsync();
        UserEmail = string.IsNullOrWhiteSpace(ctx.Email) ? "Guest" : ctx.Email;
        UserRole = ctx.User?.Role ?? "";
        CompanyName = ctx.User?.Company?.Name ?? "";

        StateHasChanged();
    }


    private void Logout() => Nav.NavigateTo("/logout", forceLoad: true);



}
