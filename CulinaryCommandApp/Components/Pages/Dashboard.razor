@page "/dashboard"
@rendermode InteractiveServer

@using CulinaryCommand.Components.Custom
@using CulinaryCommand.Services.UserContextSpace
@using CulinaryCommandApp.AIDashboard.Services.Reporting
@using CulinaryCommandApp.AIDashboard.Services.DTOs
@using CulinaryCommand.Services
@inject Microsoft.AspNetCore.Hosting.IWebHostEnvironment Env
@inject NavigationManager Nav
@inject AIReportingService ReportingService
@inject IUserContextService UserCtx

@if (!_ready)
{
    <div class="text-center mt-5">Loading…</div>
}
else if (!_isSignedIn)
{
    <div class="text-center mt-5">
        You’re not signed in.
        <button class="btn btn-success" @onclick="NavigateToSignIn">Go to Sign In</button>
    </div>
}
else
{
    <div class="container mt-4">
        @if (_role == "Admin")
        {
            <AdminView />
        }
        else if (_role == "Manager")
        {
            <ManagerView />
        }
        else
        {
            <EmployeeView />
        }

        <hr />

        <div class="card mt-4">
            <div class="card-body">
                <h5 class="card-title">Weekly Report Analysis</h5>

                @if (_aiLoading)
                {
                    <div>Loading analysis from Gemini...</div>
                }
                else if (_aiAnalysisObj == null)
                {
                    <div class="text-muted">No analysis available.</div>
                }
                else
                {
                    <!-- your existing rendering unchanged -->
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h5 class="card-title">@_aiAnalysisObj.Title</h5>
                                    <p class="card-text">@_aiAnalysisObj.Summary</p>
                                    <p class="mb-1"><small class="text-muted">Generated: @_aiAnalysisObj.GeneratedAt?.ToLocalTime().ToString("g")</small></p>
                                    <p><small class="text-muted">Confidence: @((_aiAnalysisObj.Confidence ?? 0).ToString("P0"))</small></p>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-8">
                            <div class="row g-3">
                                @if (_aiAnalysisObj.Metrics != null && _aiAnalysisObj.Metrics.Any())
                                {
                                    foreach (var m in _aiAnalysisObj.Metrics)
                                    {
                                        <div class="col-sm-6">
                                            <div class="card h-100 border-primary">
                                                <div class="card-body">
                                                    <h6 class="card-subtitle mb-2 text-muted">@m.Label</h6>
                                                    <p class="card-text fs-4">@m.Value @(!string.IsNullOrWhiteSpace(m.Unit) ? m.Unit : "")</p>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                }
                            </div>

                            <div class="mt-3">
                                @if (_aiAnalysisObj.Recommendations != null && _aiAnalysisObj.Recommendations.Any())
                                {
                                    <h6>Recommendations</h6>
                                    <ul class="list-group list-group-flush">
                                        @foreach (var r in _aiAnalysisObj.Recommendations)
                                        {
                                            <li class="list-group-item">@r</li>
                                        }
                                    </ul>
                                }
                            </div>
                        </div>
                    </div>

                    @if (_aiAnalysisObj.Sections != null && _aiAnalysisObj.Sections.Any())
                    {
                        <div class="row mt-3 g-3">
                            @foreach (var s in _aiAnalysisObj.Sections)
                            {
                                <div class="col-md-6">
                                    <div class="card h-100">
                                        <div class="card-body">
                                            <h6 class="card-title">@s.Heading</h6>
                                            <p class="card-text">@s.Body</p>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }

                    @if (_aiAnalysisObj.Anomalies != null && _aiAnalysisObj.Anomalies.Any())
                    {
                        <div class="mt-3">
                            <h6>Anomalies</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead><tr><th>Row</th><th>Reason</th></tr></thead>
                                    <tbody>
                                        @foreach (var a in _aiAnalysisObj.Anomalies)
                                        {
                                            <tr><td>@a.Row</td><td>@a.Reason</td></tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    }
                }
            </div>
        </div>
    </div>
}

@code {
    private bool _ready;
    private bool _isSignedIn;
    private string? _role;

    private bool _aiLoading;
    private string? _aiAnalysis;
    private AIAnalysisResultDTO? _aiAnalysisObj;
    private bool _aiLoadedOnce;

    protected override async Task OnInitializedAsync()
    {
        var ctx = await UserCtx.GetAsync();
        _isSignedIn = ctx.User?.Id != null;
        _role = ctx.User?.Role;

        _ready = true;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        if (_isSignedIn && !_aiLoadedOnce)
        {
            _aiLoadedOnce = true;
            _aiLoading = true;
            StateHasChanged();

            var csvPath = Path.Combine(Env.ContentRootPath, "AIDashboard", "Services", "Reporting", "test_data.csv");
            _aiAnalysis = await ReportingService.AnalyzeCsvAsync(csvPath);

            @* if (!string.IsNullOrWhiteSpace(_aiAnalysis))
            {
                try
                {
                    var options = new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true };
                    _aiAnalysisObj = System.Text.Json.JsonSerializer.Deserialize<AIAnalysisResultDTO>(_aiAnalysis, options);
                }
                catch
                {
                    _aiAnalysisObj = null;
                }
            }

            _aiLoading = false; *@
            _aiAnalysisObj = null;          //  Uncoomment above and delete curent like to activate AI
            StateHasChanged();
        }
    }

    private void NavigateToSignIn()
    {
        // This should go to your Cognito login page once that route is finalized.
        Nav.NavigateTo("/login", forceLoad: true);
    }
}
