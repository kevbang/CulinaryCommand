@rendermode InteractiveServer

@using CulinaryCommand.Data.Entities
@using CulinaryCommand.Services
@using CulinaryCommand.Services.UserContextSpace

@inject NavigationManager Nav
@inject ICompanyService CompanyService
@inject IUserContextService UserCtx

<div class="tab-pane active">
    <h4 class="mb-4">
        <i class="fas fa-building me-2"></i>Company Settings
    </h4>

    @if (!_ready)
    {
        <div>Loading...</div>
    }
    else if (!_allowed)
    {
        <div class="alert alert-warning">
            You do not have permission to manage company settings.
        </div>
    }
    else if (companyModel is null)
    {
        <div class="alert alert-warning">
            You do not belong to a company yet. Create one below.
        </div>

        <EditForm Model="@createCompanyModel" OnValidSubmit="@HandleCreateCompany">
            <DataAnnotationsValidator />

            <div class="mb-3">
                <label class="form-label">Company Name</label>
                <InputText class="form-control" @bind-Value="createCompanyModel.Name" />
            </div>

            <div class="mb-3">
                <label class="form-label">Company Code</label>
                <InputText class="form-control" @bind-Value="createCompanyModel.CompanyCode" />
            </div>

            <button class="btn btn-primary" disabled="@_saving">
                @(_saving ? "Creating..." : "Create Company")
            </button>
        </EditForm>

        <hr class="my-4" />
    }
    else
    {
        <EditForm Model="@companyModel" OnValidSubmit="@HandleCompanySubmit">
            <DataAnnotationsValidator />

            <div class="mb-3">
                <label class="form-label">Company Name</label>
                <InputText class="form-control" @bind-Value="companyModel.Name" />
            </div>

            <div class="mb-3">
                <label class="form-label">Company Code</label>
                <InputText class="form-control" @bind-Value="companyModel.CompanyCode" />
            </div>

            <button class="btn btn-success" disabled="@_saving">
                @(_saving ? "Saving..." : "Update Company")
            </button>
        </EditForm>
    }
</div>

@code {
    private UserContext? _ctx;

    private bool _ready;
    private bool _allowed;
    private bool _saving;

    private CompanyModel? companyModel;
    private CompanyModel createCompanyModel = new();

    protected override async Task OnInitializedAsync()
    {
        _ctx = await UserCtx.GetAsync();

        if (_ctx.IsAuthenticated != true)
        {
            Nav.NavigateTo("/login", true);
            return;
        }

        if (_ctx.User is null)
        {
            Nav.NavigateTo("/no-access", true);
            return;
        }

        // Gate: Admin only (change if needed)
        _allowed = string.Equals(_ctx.User.Role, "Admin", StringComparison.OrdinalIgnoreCase);

        if (_allowed && _ctx.User.Company is not null)
        {
            companyModel = new CompanyModel
            {
                Id = _ctx.User.Company.Id,
                Name = _ctx.User.Company.Name,
                CompanyCode = _ctx.User.Company.CompanyCode
            };
        }

        _ready = true;
    }

    private async Task HandleCompanySubmit()
    {
        if (!_allowed || companyModel is null) return;
        if (_saving) return;

        _saving = true;
        try
        {
            var updated = new Company
            {
                Id = companyModel.Id,
                Name = companyModel.Name ?? string.Empty,
                CompanyCode = companyModel.CompanyCode ?? string.Empty
            };

            await CompanyService.UpdateCompanyAsync(updated);

            // Refresh user context so other UI sees latest company/locations
            _ctx = await UserCtx.RefreshAsync();

            // Re-hydrate the form model from refreshed context if present
            if (_ctx.User?.Company is not null)
            {
                companyModel = new CompanyModel
                {
                    Id = _ctx.User.Company.Id,
                    Name = _ctx.User.Company.Name,
                    CompanyCode = _ctx.User.Company.CompanyCode
                };
            }
        }
        finally
        {
            _saving = false;
        }
    }

    private async Task HandleCreateCompany()
    {
        if (!_allowed) return;
        if (_saving) return;

        _saving = true;
        try
        {
            var newCompany = new Company
            {
                Name = createCompanyModel.Name ?? string.Empty,
                CompanyCode = createCompanyModel.CompanyCode ?? string.Empty
            };

            var created = await CompanyService.CreateCompanyAsync(newCompany);

            // IMPORTANT:
            // Your DB also needs to link the current user to this company.
            // If CreateCompanyAsync DOES NOT do that, you'll want a UserService method like:
            //   await UserService.AssignCompanyAsync(_ctx.User.Id, created.Id);
            // For now we refresh and rely on your backend behavior.

            _ctx = await UserCtx.RefreshAsync();

            companyModel = new CompanyModel
            {
                Id = created.Id,
                Name = created.Name,
                CompanyCode = created.CompanyCode
            };
        }
        finally
        {
            _saving = false;
        }
    }

    private class CompanyModel
    {
        public int Id { get; set; }
        public string? Name { get; set; }
        public string? CompanyCode { get; set; }
    }
}
