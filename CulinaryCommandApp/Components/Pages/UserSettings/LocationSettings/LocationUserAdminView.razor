@using CulinaryCommand.Models
@using CulinaryCommand.Data.Entities
@inject IUserService UserService
@inject ILocationService LocationService
@inject AuthService Auth
@inject NavigationManager Nav

<div class="location-user-admin">

    <h4 class="mb-3">Users Assigned to This Location</h4>

    <button class="btn btn-success mb-3" @onclick="ShowInviteForm">
        <i class="bi bi-person-plus me-2"></i>Invite User
    </button>

    @if (showInvite)
    {
        <InviteUserForm 
            LocationId="LocationId"
            OnClose="HideInviteForm"
            OnInvited="ReloadUsers" />
    }

    @if (Users.Count == 0)
    {
        <div class="alert alert-info">
            No users assigned to this location yet.
        </div>
    }
    else
    {
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Role</th>
                    <th style="width: 150px;"></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var user in Users)
                {
                    <tr>
                        <td>@user.Name</td>
                        <td>@user.Email</td>
                        <td>@user.Role</td>
                        <td class="text-end">

                            @if (user.Role == "Manager")
                            {
                                <button class="btn btn-warning btn-sm me-2"
                                        @onclick="() => Demote(user)">
                                    Demote
                                </button>
                            }
                            else
                            {
                                <button class="btn btn-primary btn-sm me-2"
                                        @onclick="() => Promote(user)">
                                    Promote
                                </button>
                            }

                            <button class="btn btn-danger btn-sm"
                                    @onclick="() => RemoveUser(user)">
                                Remove
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }

</div>

@code {
    [Parameter] public int LocationId { get; set; }

    private bool showInvite = false;
    private bool hydrated = false;
    private List<User> Users = new();

    protected override async Task OnAfterRenderAsync(bool firstRender)
        {
            if (!firstRender)
                return;

            // Must wait for hydration here
            await Auth.EnsureHydratedAsync();

            // Redirect only AFTER hydration
            if (!Auth.IsSignedIn)
            {
                Nav.NavigateTo("/signin", replace: true);
                return;
            }

            await ReloadUsers();

            hydrated = true;
            StateHasChanged();
        }

    private async Task ReloadUsers()
    {
        Users = await LocationService.GetUsersForLocationAsync(LocationId);
        StateHasChanged();
    }

    private void ShowInviteForm() => showInvite = true;
    private void HideInviteForm() => showInvite = false;

    private async Task RemoveUser(User user)
    {
        await LocationService.RemoveUserFromLocationAsync(LocationId, user.Id);

        if (user.Role == "Manager")
            await LocationService.RemoveManagerFromLocationAsync(LocationId, user.Id);

        await ReloadUsers();
    }

    private async Task Promote(User user)
    {
        // change role
        user.Role = "Manager";
        await UserService.UpdateUserAsync(user);

        await LocationService.AddManagerToLocationAsync(LocationId, user.Id);

        await ReloadUsers();
    }

    private async Task Demote(User user)
    {
        user.Role = "Employee";
        await UserService.UpdateUserAsync(user);

        await LocationService.RemoveManagerFromLocationAsync(LocationId, user.Id);

        await ReloadUsers();
    }
}