@using CulinaryCommand.Models
@using CulinaryCommand.Data.Entities
@inject IUserService UserService
@inject ILocationService LocationService
@inject AuthService Auth
@inject NavigationManager Nav

<div class="location-user-admin">

    <h4 class="mb-3">Users Assigned to This Location</h4>

    <button class="btn btn-success mb-3" @onclick="ShowInviteForm">
        <i class="bi bi-person-plus me-2"></i>Invite User
    </button>

    <button class="btn btn-outline-primary mb-3 ms-2" @onclick="ShowAddExistingForm">
        <i class="bi bi-person-check me-2"></i>Add Existing User
    </button>

    @if (showInvite)
    {
        <InviteUserForm 
            LocationId="LocationId"
            OnClose="HideInviteForm"
            OnInvited="ReloadUsers" />
    }

    @if (showAddExisting)
    {
        <div class="card card-body mb-3">
            <label class="form-label fw-semibold">Select Existing User</label>

            <select class="form-select" @bind="selectedUserId">
                <option value="">-- Select User --</option>
                @foreach (var u in AvailableUsers)
                {
                    <option value="@u.Id">@u.Name (@u.Email)</option>
                }
            </select>

            <div class="mt-3 d-flex gap-2">
                <button class="btn btn-success" @onclick="AddExistingUser"
                        disabled="@(!CanAddExisting)">
                    Add to Location
                </button>

                <button class="btn btn-outline-secondary" @onclick="HideAddExistingForm">
                    Cancel
                </button>
            </div>
        </div>
    }

    @if (Users.Count == 0)
    {
        <div class="alert alert-info">No users assigned to this location yet.</div>
    }
    else
    {
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Role</th>
                    <th style="width: 150px;"></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var user in Users)
                {
                    <tr>
                        <td>@user.Name</td>
                        <td>@user.Email</td>
                        <td>@user.Role</td>
                        <td class="text-end">

                            <div class="d-flex justify-content-end">
                                @if (user.Role == "Manager")
                                {
                                    <button class="btn btn-warning btn-sm me-2"
                                            @onclick="() => Demote(user)">
                                        Demote
                                    </button>
                                }
                                else if (user.Role == "Employee")
                                {
                                    <button class="btn btn-primary btn-sm me-2"
                                            @onclick="() => Promote(user)">
                                        Promote
                                    </button>
                                }
                                @if (!(user.Role == "Admin" && user.Id == Auth.CurrentUser?.Id)) {
                                    @* Admins shouldn't be able to remove themselves *@
                                    <button class="btn btn-danger btn-sm"
                                            @onclick="() => RemoveUser(user)">
                                        Remove
                                    </button>
                                }
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }

</div>

@code {
    [Parameter] public int LocationId { get; set; }

    private bool showInvite = false;
    private bool showAddExisting = false;

    private bool hydrated = false;

    private List<User> Users = new();
    private List<User> AvailableUsers = new();

    private string? selectedUserId; // dropdown binding

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender)
            return;

        await Auth.EnsureHydratedAsync();

        if (!Auth.IsSignedIn)
        {
            Nav.NavigateTo("/signin", replace: true);
            return;
        }

        await ReloadUsers();
        await LoadAvailableUsers();

        hydrated = true;
        StateHasChanged();
    }

    private async Task ReloadUsers()
    {
        Users = await LocationService.GetUsersForLocationAsync(LocationId);
        await LoadAvailableUsers();
        StateHasChanged();
    }

    private async Task LoadAvailableUsers()
    {
        if (Auth.CompanyId == null) return;

        var companyUsers = await UserService.GetUsersByCompanyAsync(Auth.CompanyId.Value);

        var assignedIds = Users.Select(u => u.Id).ToHashSet();

        AvailableUsers = companyUsers
            .Where(u => !assignedIds.Contains(u.Id))
            .OrderBy(u => u.Name)
            .ToList();
    }

    // ---------------------------
    // ADD EXISTING USER LOGIC
    // ---------------------------

    private void ShowAddExistingForm() => showAddExisting = true;
    private void HideAddExistingForm()
    {
        showAddExisting = false;
        selectedUserId = null;
    }

    private bool CanAddExisting => !string.IsNullOrWhiteSpace(selectedUserId);

    private async Task AddExistingUser()
    {
        if (!int.TryParse(selectedUserId, out var userId))
            return;

        var UserToAdd = AvailableUsers.FirstOrDefault(u =>  u.Id == userId);

        if (UserToAdd != null) {
            // add to general user mapping
            await LocationService.AddUserToLocationAsync(LocationId, userId);

            // add to manager list if user is manager
            if (UserToAdd.Role == "Manager") {
                await LocationService.AddManagerToLocationAsync(LocationId, userId);
            }
        }

        await ReloadUsers();
        HideAddExistingForm();
    }

    // ---------------------------
    // Existing logic unchanged
    // ---------------------------

    private void ShowInviteForm() => showInvite = true;
    private void HideInviteForm() => showInvite = false;

    private async Task RemoveUser(User user)
    {
        await LocationService.RemoveUserFromLocationAsync(LocationId, user.Id);

        if (user.Role == "Manager")
            await LocationService.RemoveManagerFromLocationAsync(LocationId, user.Id);

        await ReloadUsers();
    }

    private async Task Promote(User user)
    {
        user.Role = "Manager";
        await UserService.UpdateUserAsync(user);
        await LocationService.AddManagerToLocationAsync(LocationId, user.Id);
        await ReloadUsers();
    }

    private async Task Demote(User user)
    {
        user.Role = "Employee";
        await UserService.UpdateUserAsync(user);
        await LocationService.RemoveManagerFromLocationAsync(LocationId, user.Id);
        await ReloadUsers();
    }
}