@using CulinaryCommand.Models
@inject IUserService UserService
@inject AuthService Auth

<div class="card shadow-sm p-3 mb-4">

    <h5 class="mb-3">Invite New User</h5>

    @if (!hydrated)
    {
        <p>Loading...</p>
    }
    else
    {
        <EditForm Model="@Model" OnValidSubmit="Invite">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">First Name</label>
                    <InputText class="form-control" @bind-Value="Model.FirstName" />
                </div>
                <div class="col-md-6">
                    <label class="form-label">Last Name</label>
                    <InputText class="form-control" @bind-Value="Model.LastName" />
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label">Email</label>
                <InputText class="form-control" @bind-Value="Model.Email" />
            </div>

            <div class="mb-3">
                <label class="form-label">Role</label>
                <InputSelect class="form-select" @bind-Value="Model.Role">
                    <option value="">Select role</option>
                    <option value="Employee">Employee</option>
                    <option value="Manager">Manager</option>
                </InputSelect>
            </div>

            <button type="submit" class="btn btn-success">Send Invite</button>
            <button type="button" class="btn btn-outline-secondary ms-2" @onclick="Close">Cancel</button>
        </EditForm>
    }

</div>

@code {
    [Parameter] public int LocationId { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public EventCallback OnInvited { get; set; }

    private CreateUserForLocationRequest Model = new();
    private bool hydrated = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        // Wait for auth hydrate
        await Auth.EnsureHydratedAsync();

        if (!Auth.IsSignedIn)
        {
            // Form shouldn't operate if user is not auth'd
            await OnClose.InvokeAsync();
            return;
        }

        // Now set model
        Model.LocationId = LocationId;

        hydrated = true;
        StateHasChanged();
    }

    private async Task Invite()
    {
        // Auth is guaranteed hydrated now
        var newUser = await UserService.CreateInvitedUserForLocationAsync(
            Model,
            Auth.CompanyId!.Value,
            Auth.UserId!.Value
        );

        await UserService.SendInviteEmailAsync(newUser);

        await OnInvited.InvokeAsync();
        await OnClose.InvokeAsync();
    }

    private async Task Close() => await OnClose.InvokeAsync();
}