@rendermode InteractiveServer

@using CulinaryCommand.Components.Pages.UserSettings.LocationSettings
@using CulinaryCommand.Data.Entities
@using CulinaryCommand.Services.UserContextSpace

@inject ILocationService LocationService
@inject IUserContextService UserCtx
@inject NavigationManager Nav

<div>
    @if (!hydrated)
    {
        <p>Loading locations...</p>
    }
    else if (!_allowed)
    {
        <div class="alert alert-warning">
            You need to be signed in and assigned to a company to manage locations.
        </div>
    }
    else
    {
        @if (IsAdmin)
        {
            <LocationAdminView
                Locations="locations"
                OnCreate="Create"
                OnEdit="Update"
                OnDelete="Delete" />
        }
        else if (IsManager)
        {
            <LocationManagerView
                Locations="locations"
                OnEdit="Update" />
        }
        else // Auth.UserRole == "Employee"
        {
            <LocationEmployeeView Locations="locations" />
        }
    }
</div>

@code {
    private List<Location> locations = new();
    private Location? employeeLocation;
    private bool hydrated = false;

    private UserContext? _ctx;
    private bool _allowed;

    private bool IsAdmin => string.Equals(_ctx?.User?.Role, "Admin", StringComparison.OrdinalIgnoreCase);
    private bool IsManager => string.Equals(_ctx?.User?.Role, "Manager", StringComparison.OrdinalIgnoreCase);

    protected override async Task OnInitializedAsync()
    {
        _ctx = await UserCtx.GetAsync();

        // Not authenticated => go to Cognito login route
        if (_ctx.IsAuthenticated != true)
        {
            Nav.NavigateTo("/login", true);
            return;
        }

        // Invite-only: authenticated but not in DB
        if (_ctx.User is null)
        {
            Nav.NavigateTo("/no-access", true);
            return;
        }

        // Must have company to manage locations (admins/managers/employees)
        _allowed = _ctx.User.CompanyId is not null;

        if (_allowed)
            await LoadLocations();

        hydrated = true;
    }

    private async Task LoadLocations()
    {
        if (_ctx?.User is null) return;

        if (IsAdmin)
        {
            if (_ctx.User.CompanyId is null) { locations = new(); return; }
            locations = await LocationService.GetLocationsByCompanyAsync(_ctx.User.CompanyId.Value);
            employeeLocation = null;
        }
        else if (IsManager)
        {
            locations = await LocationService.GetLocationsByManagerAsync(_ctx.User.Id);
            employeeLocation = null;
        }
        else
        {
            employeeLocation = (await LocationService.GetLocationsByEmployeeAsync(_ctx.User.Id)).FirstOrDefault();
            locations = new();
        }
    }

    private async Task Create(Location loc)
    {
        if (_ctx?.User?.CompanyId is null) return;

        loc.CompanyId = _ctx.User.CompanyId.Value;

        // CreateLocationAsync(loc, createdByUserId)
        await LocationService.CreateLocationAsync(loc, _ctx.User.Id);

        await LoadLocations();
        StateHasChanged();
    }

    private async Task Update(Location loc)
    {
        await LocationService.UpdateLocationAsync(loc);
        await LoadLocations();
        StateHasChanged();
    }

    private async Task Delete(int id)
    {
        await LocationService.DeleteLocationAsync(id);
        await LoadLocations();
        StateHasChanged();
    }
}
