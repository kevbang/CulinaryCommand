@page "/users/edit/{id:int}"
@rendermode InteractiveServer

@using CulinaryCommand.Data.Entities
@using CulinaryCommand.Services.UserContextSpace

@inject IUserService UserService
@inject IUserContextService UserCtx
@inject NavigationManager Nav

<h3>Edit User</h3>

@if (model == null)
{
    <p>Loading...</p>
}
else if (!_allowed)
{
    <div class="alert alert-warning">
        You do not have permission to edit users.
    </div>
}
else
{
    <UserForm Model="model" FormTitle="Edit User" OnValidSubmit="Save" />
}

@code {
    [Parameter] public int id { get; set; }

    private User? model;
    private bool _allowed;
    private UserContext? _ctx;

    protected override async Task OnInitializedAsync()
    {
        _ctx = await UserCtx.GetAsync();

        if (_ctx.IsAuthenticated != true)
        {
            Nav.NavigateTo("/login", true);
            return;
        }

        if (_ctx.User is null)
        {
            Nav.NavigateTo("/no-access", true);
            return;
        }

        _allowed =
            string.Equals(_ctx.User.Role, "Admin", StringComparison.OrdinalIgnoreCase) ||
            string.Equals(_ctx.User.Role, "Manager", StringComparison.OrdinalIgnoreCase);

        // Load model either way so the page can show something (or you can early-return if you prefer)
        model = await UserService.GetUserByIdAsync(id);
    }

    private async Task Save(User u)
    {
        if (!_allowed)
            return;

        await UserService.UpdateUserAsync(u);

        // If UserLocations is null, don't blow up
        var locIds = u.UserLocations?.Select(x => x.LocationId).ToList() ?? new List<int>();
        await UserService.AssignLocationsAsync(u.Id, locIds);

        Nav.NavigateTo("/users");
    }
}
