@rendermode InteractiveServer

@using CulinaryCommand.Models
@using CulinaryCommand.Services.UserContextSpace


@inject IUserService UserService
@inject IUserContextService UserCtx

<div class="cc-invite-wrap">

    <h5 class="cc-invite-title">Invite a User</h5>
    <p class="cc-invite-subtitle">Send an invite link so they can set their password and sign in.</p>

    @if (!hydrated)
    {
        <div class="cc-muted">Loading...</div>
    }
    else if (!_allowed)
    {
        <div class="alert alert-warning mb-0">
            You do not have permission to invite users for this location.
        </div>
    }
    else if (invalid)
    {
        <div class="alert alert-danger">
            Something went wrong. Please check the form and try again.
        </div>
    }
    else if (success)
    {
        <div class="alert alert-success">
            Invite sent! They can use the invite link to set a password and sign in.
        </div>

        <div class="d-flex gap-2">
            <button type="button" class="btn btn-success" @onclick="Close">Done</button>
            <button type="button" class="btn btn-outline-secondary" @onclick="InviteAnother">Invite Another</button>
        </div>
    }
    else
    {
        <EditForm Model="@Model" OnValidSubmit="Invite">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">First Name</label>
                    <InputText class="form-control" @bind-Value="Model.FirstName" />
                </div>
                <div class="col-md-6">
                    <label class="form-label">Last Name</label>
                    <InputText class="form-control" @bind-Value="Model.LastName" />
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label">Email</label>
                <InputText class="form-control" @bind-Value="Model.Email" />
            </div>

            <div class="mb-3">
                <label class="form-label">Role</label>
                <InputSelect class="form-select" @bind-Value="Model.Role">
                    <option value="">Select role</option>
                    <option value="Employee">Employee</option>
                    <option value="Manager">Manager</option>
                </InputSelect>
            </div>

            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-success" disabled="@submitting">
                    @(submitting ? "Sending..." : "Send Invite")
                </button>

                <button type="button" class="btn btn-outline-secondary" @onclick="Close" disabled="@submitting">
                    Cancel
                </button>
            </div>
        </EditForm>
    }

</div>

@code {
    [Parameter] public int LocationId { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public EventCallback OnInvited { get; set; }

    private CreateUserForLocationRequest Model = new();

    private bool hydrated = false;
    private bool _allowed = false;

    private bool invalid = false;
    private bool success = false;
    private bool submitting = false;

    private UserContext? _ctx;

    protected override async Task OnInitializedAsync()
    {
        _ctx = await UserCtx.GetAsync();

        if (_ctx?.IsAuthenticated != true || _ctx.User is null)
        {
            await OnClose.InvokeAsync();
            return;
        }

        _allowed =
            string.Equals(_ctx.User.Role, "Admin", StringComparison.OrdinalIgnoreCase) ||
            string.Equals(_ctx.User.Role, "Manager", StringComparison.OrdinalIgnoreCase);

        Model.LocationId = LocationId;

        hydrated = true;
    }

    private async Task Invite()
    {
        invalid = false;

        if (!_allowed || _ctx?.User is null) { invalid = true; return; }
        if (_ctx.User.CompanyId is null) { invalid = true; return; }
        if (submitting) return;

        submitting = true;

        try
        {
            var newUser = await UserService.CreateInvitedUserForLocationAsync(
                Model,
                _ctx.User.CompanyId.Value,
                _ctx.User.Id
            );

            await UserService.SendInviteEmailAsync(newUser);

            success = true;
            await OnInvited.InvokeAsync();
        }
        catch
        {
            invalid = true;
        }
        finally
        {
            submitting = false;
        }
    }

    private async Task Close()
    {
        await OnClose.InvokeAsync();
    }

    private void InviteAnother()
    {
        Model = new CreateUserForLocationRequest
        {
            LocationId = LocationId
        };

        invalid = false;
        success = false;
        submitting = false;
    }
}

<style>
    .cc-invite-wrap{
        border-radius: 16px;
        border: 1px solid rgba(17,24,39,.08);
        background: #fff;
        padding: 16px;
        box-shadow: 0 8px 20px rgba(17,24,39,.05);
    }

    .cc-invite-title{
        font-weight: 850;
        margin-bottom: 2px;
        color: #111827;
        letter-spacing: -0.2px;
    }

    .cc-invite-subtitle{
        color: #6b7280;
        font-size: 13px;
        margin-bottom: 12px;
    }

    .cc-muted{
        color: #6b7280;
        font-size: 13px;
    }
</style>
