@page "/inventory-management/{LocationId:int}"
@rendermode InteractiveServer
@implements IDisposable

@using CulinaryCommand.Inventory.DTOs
@using CulinaryCommand.Inventory.Entities
@using CulinaryCommand.Inventory.Services
@using CulinaryCommand.Inventory.Services.Interfaces
@using Microsoft.JSInterop
@using Microsoft.AspNetCore.Components.Forms

@using CulinaryCommand.Vendor.Services
@using CulinaryCommand.Vendor.Entities
@using CulinaryCommand.Services

@inject IInventoryManagementService InventoryService
@inject IUnitService UnitService
@inject IVendorService VendorService
@inject LocationState LocationState
@inject NavigationManager Nav

<div class="inventory-container">
    <div class="inventory-header">
        <div class="header-text">
            <h1>Inventory Management</h1>
            <p>Manage your stock</p>
        </div>
    </div>

    <div class="inventory-toolbar">
        <div class="search-bar">
            <i class="bi bi-search"></i>
            <input type="text" placeholder="Search Ingredients by name, category, or supplier..." @bind="SearchTerm" @bind:event="oninput" />
        </div>
        <div class="toolbar-actions">
            <button class="icon-btn" @onclick="ExportInventory" title="Export">
                <i class="bi bi-download"></i>
            </button>
            <button class="icon-btn" @onclick="RefreshInventory" title="Refresh">
                <i class="bi bi-arrow-clockwise"></i>
            </button>
            <button class="icon-btn" @onclick="ToggleQuickFilter" title="Quick filter">
                <i class="bi bi-funnel"></i>
            </button>
            <div class="select-wrap">
                <select class="form-select" @bind="SelectedCategory">
                    <option value="">All Categories</option>
                    @foreach (var category in categories)
                    {
                        <option value="@category">@category</option>
                    }
                </select>
            </div>
            <div class="select-wrap">
                <select class="form-select" @bind="StockStatus">
                    <option value="">Stock Status</option>
                    <option value="low">Low Stock</option>
                    <option value="out">Out of Stock</option>
                    <option value="sufficient">In Stock</option>
                </select>
            </div>
            <button class="btn-add" @onclick="ShowAddItemModal">
                <i class="bi bi-plus-lg"></i> Add Item
            </button>
        </div>
    </div>

    <div class="tab-row">
        <button class="tab-btn @(activeTab == "all" ? "active" : "")" @onclick='() => SetActiveTab("all")'>
            All Items (@inventoryItems.Count)
        </button>
        <button class="tab-btn @(activeTab == "low" ? "active" : "")" @onclick='() => SetActiveTab("low")'>
            Low Stock (@inventoryItems.Count(i => i.IsLowStock))
        </button>
        <button class="tab-btn @(activeTab == "out" ? "active" : "")" @onclick='() => SetActiveTab("out")'>
            Out of Stock (@inventoryItems.Count(i => i.CurrentQuantity <= 0))
        </button>
    </div>

    <div class="inventory-table-container">
        <table class="inventory-table">
            <thead>
                <tr>
                    <th class="checkbox-col">
                        <input type="checkbox" checked="@IsPageSelected" @onchange="ToggleSelectAll" />
                    </th>
                    <th @onclick='() => SortBy("name")'>Name <i class="bi bi-arrow-down-up"></i></th>
                    <th>Category</th>
                    <th>Unit</th>
                    <th @onclick='() => SortBy("currentQty")'>Current Stock <i class="bi bi-arrow-down-up"></i></th>
                    <th @onclick='() => SortBy("expires")'>Expires <i class="bi bi-arrow-down-up"></i></th>
                    <th @onclick='() => SortBy("price")'>Cost/Unit <i class="bi bi-arrow-down-up"></i></th>
                    <th>Supplier</th>
                    <th>Location</th>
                    <th @onclick='() => SortBy("lastUpdated")'>Last Updated <i class="bi bi-arrow-down-up"></i></th>
                    <th class="actions-col">Actions</th>
                </tr>
            </thead>
            <tbody>
                @if (isLoading)
                {
                    <tr>
                        <td colspan="10" class="text-center py-4">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </td>
                    </tr>
                }
                else if (!pagedItems.Any())
                {
                    <tr>
                        <td colspan="10" class="text-center py-4">
                            <p class="text-muted">No items found</p>
                        </td>
                    </tr>
                }
                else
                {
                    @foreach (var item in pagedItems)
                    {
                        <tr>
                            <td class="checkbox-col">
                                <input type="checkbox" checked="@selectedIds.Contains(item.Id)" @onchange="(e) => ToggleSelection(item.Id, e)" />
                            </td>
                            <td>
                                <div class="name-cell">
                                    <div class="item-name">@item.Name</div>
                                    <div class="item-sku">SKU: @item.SKU</div>
                                </div>
                            </td>
                            <td>
                                <span class="category-pill @GetCategoryClass(item.Category)">@item.Category</span>
                            </td>
                            <td>@item.Unit</td>
                            <td>
                                <div class="stock-cell">
                                    <span class="stock-value">@item.CurrentQuantity</span>
                                    @if (item.CurrentQuantity <= 0)
                                    {
                                        <span class="stock-indicator out"><i class="bi bi-x-circle"></i></span>
                                    }
                                    else if (item.IsLowStock)
                                    {
                                        <span class="stock-indicator low"><i class="bi bi-exclamation-triangle"></i></span>
                                    }
                                </div>
                            </td>
                            <td>@(item.OutOfStockDate.HasValue ? item.OutOfStockDate.Value.ToString("M/d/yy") : "-")</td>
                            <td>$@item.Price.ToString("F2")</td>
                            <td>
                                @if (!string.IsNullOrEmpty(item.VendorLogoUrl))
                                {
                                    <img src="@item.VendorLogoUrl" alt="@item.VendorName"
                                         title="@item.VendorName"
                                         style="width:28px;height:28px;object-fit:contain;border-radius:4px;" />
                                }
                                else if (!string.IsNullOrEmpty(item.VendorName))
                                {
                                    <span class="text-muted small">@item.VendorName</span>
                                }
                                else
                                {
                                    <span class="text-muted">—</span>
                                }
                            </td>
                            <td>@GetLocation(item.Id)</td>
                            <td>@(item.LastOrderDate.HasValue ? item.LastOrderDate.Value.ToString("M/d/yy") : "-")</td>
                            <td class="actions-col">
                                <div class="action-buttons">
                                    <button class="btn-action" @onclick="() => EditItem(item)" title="Edit">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn-action" @onclick="() => OrderItem(item)" title="Order">
                                        <i class="bi bi-cart-plus"></i>
                                    </button>
                                    <button class="btn-action delete" @onclick="() => DeleteItem(item)" title="Delete">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
        <div class="table-footer">
            <div class="footer-count">Showing @GetStartIndex()-@GetEndIndex() of @filteredItems.Count Ingredients</div>
            <div class="pagination">
                <button class="page-nav" @onclick="PreviousPage" disabled="@(currentPage <= 1)">
                    <i class="bi bi-chevron-left"></i>
                </button>
                @foreach (var pageNum in pageButtons)
                {
                    if (pageNum < 0)
                    {
                        <span class="page-ellipsis">...</span>
                    }
                    else
                    {
                        <button class="page-btn @(currentPage == pageNum ? "active" : "")" @onclick="() => GoToPage(pageNum)">@pageNum</button>
                    }
                }
                <button class="page-nav" @onclick="NextPage" disabled="@(currentPage >= totalPages)">
                    <i class="bi bi-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Item Modal -->
@if (showModal)
{
    <div class="modal-backdrop" @onclick="CloseModal"></div>
    <div class="modal-dialog-custom">
        <div class="modal-content-custom">
            <div class="modal-header-custom">
                <h3>@(editingItem == null ? "Add New Item" : "Edit Item")</h3>
                <button class="btn-close-custom" @onclick="CloseModal">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div class="modal-body-custom">
                <div class="form-group mb-3">
                    <label>Item Name</label>
                    <input type="text" class="form-control" @bind="modalItem.Name" />
                </div>
                <div class="form-group mb-3">
                    <label>SKU</label>
                    <input type="text" class="form-control" @bind="modalItem.SKU" />
                </div>
                <div class="form-group mb-3">
                    <label>Category</label>
                    <select class="form-control" @bind="modalItem.Category">
                        <option value="">Select Category</option>
                        @foreach (var category in categories)
                        {
                            <option value="@category">@category</option>
                        }
                    </select>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label>Current Quantity</label>
                            <input type="number" class="form-control" @bind="modalItem.CurrentQuantity" />
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label>Unit</label>
                            <select class="form-control" @bind="modalUnitId">
                                <option value="0">-- Select Unit --</option>
                                @foreach (var unit in availableUnits)
                                {
                                    <option value="@unit.Id">@unit.Name (@unit.Abbreviation)</option>
                                }
                            </select>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label>Price</label>
                            <input type="number" step="0.01" class="form-control" @bind="modalItem.Price" />
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label>Order limit</label>
                            <input type="number" class="form-control" @bind="modalItem.ReorderLevel" />
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label>Expires</label>
                            <InputDate class="form-control" @bind-Value="modalItem.OutOfStockDate" />
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label>Last Updated</label>
                            <InputDate class="form-control" @bind-Value="modalItem.LastOrderDate" />
                        </div>
                    </div>
                </div>
                <div class="form-group mb-3">
                    <label>Notes</label>
                    <input type="text" class="form-control" @bind="modalItem.Notes" />
                </div>
                <div class="form-group mb-3">
                    <label>Supplier</label>
                    <select class="form-control" @bind="modalVendorId">
                        <option value="0">-- No Supplier --</option>
                        @foreach (var vendor in locationVendors)
                        {
                            <option value="@vendor.Id">
                                @vendor.Name
                            </option>
                        }
                    </select>
                    @if (modalVendorId > 0)
                    {
                        var selectedVendor = locationVendors.FirstOrDefault(v => v.Id == modalVendorId);
                        @if (selectedVendor?.LogoUrl is not null)
                        {
                            <div class="mt-2 d-flex align-items-center gap-2">
                                <img src="@selectedVendor.LogoUrl" alt="@selectedVendor.Name"
                                     style="width:32px;height:32px;object-fit:contain;border-radius:4px;" />
                                <span class="small text-muted">@selectedVendor.Name</span>
                            </div>
                        }
                    }
                </div>
            </div>
            <div class="modal-footer-custom">
                <button class="btn btn-secondary" @onclick="CloseModal">Cancel</button>
                <button class="btn btn-success" @onclick="SaveItem">
                    @(editingItem == null ? "Add Item" : "Save Changes")
                </button>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public int LocationId { get; set; }

    private List<InventoryItemDTO> inventoryItems = new();
    private List<InventoryItemDTO> filteredItems = new();
    private List<InventoryItemDTO> pagedItems = new();
    private List<Unit> availableUnits = new();
    private List<Vendor> locationVendors = new();
    private bool isLoading = true;
    private string activeTab = "all";
    private string searchTerm = "";
    private string selectedCategory = "";
    private string stockStatus = "";
    private string sortColumn = "";
    private bool sortAscending = true;
    private int currentPage = 1;
    private int pageSize = 10;
    private int totalPages = 1;
    private List<int> pageButtons = new();
    private HashSet<int> selectedIds = new();

    private List<string> categories = new();

    private bool showModal = false;
    private InventoryItemDTO modalItem = new();
    private InventoryItemDTO? editingItem = null;
    private int modalUnitId = 0;
    private int modalVendorId = 0;

    protected override async Task OnInitializedAsync()
    {
        availableUnits = await UnitService.GetAllAsync();
        locationVendors = await VendorService.GetVendorsByLocationAsync(LocationId);
        await LoadInventoryData();

        LocationState.OnChange += HandleLocationChange;
    }

    private void HandleLocationChange()
    {
        _ = InvokeAsync(async () =>
        {
            var newLocId = LocationState.CurrentLocation?.Id;
            if (newLocId.HasValue && newLocId.Value != LocationId)
            {
                Nav.NavigateTo($"/inventory-management/{newLocId.Value}");
            }
            else
            {
                // Same location — just refresh the data
                await LoadInventoryData();
                locationVendors = await VendorService.GetVendorsByLocationAsync(LocationId);
                StateHasChanged();
            }
        });
    }

    public void Dispose()
    {
        LocationState.OnChange -= HandleLocationChange;
    }

    private async Task LoadInventoryData()
    {
        isLoading = true;
        inventoryItems = await InventoryService.GetItemsByLocationAsync(LocationId);
        categories = await InventoryService.GetCategoriesByLocationAsync(LocationId);
        FilterItems();
        isLoading = false;
    }

    private void SetActiveTab(string tab)
    {
        activeTab = tab;
        FilterItems();
    }

    private void FilterItems()
    {
        currentPage = 1;
        filteredItems = inventoryItems.Where(item =>
        {
            // Tab filter
            bool tabMatch = activeTab switch
            {
                "low" => item.IsLowStock,
                "out" => item.CurrentQuantity <= 0,
                _ => true
            };

            // Search filter
            bool searchMatch = string.IsNullOrWhiteSpace(searchTerm) ||
                item.Name.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                item.SKU.Contains(searchTerm, StringComparison.OrdinalIgnoreCase);

            // Category filter
            bool categoryMatch = string.IsNullOrWhiteSpace(selectedCategory) ||
                item.Category == selectedCategory;

            // Stock status filter
            bool stockMatch = stockStatus switch
            {
                "low" => item.IsLowStock,
                "out" => item.CurrentQuantity <= 0,
                "sufficient" => !item.IsLowStock && item.CurrentQuantity > 0,
                _ => true
            };

            return tabMatch && searchMatch && categoryMatch && stockMatch;
        }).ToList();

        ApplySorting();
        UpdatePagination();
    }

    private void SortBy(string column)
    {
        if (sortColumn == column)
        {
            sortAscending = !sortAscending;
        }
        else
        {
            sortColumn = column;
            sortAscending = true;
        }
        ApplySorting();
        UpdatePagination();
    }

    private void ApplySorting()
    {
        filteredItems = sortColumn switch
        {
            "name" => sortAscending ? filteredItems.OrderBy(i => i.Name).ToList() : filteredItems.OrderByDescending(i => i.Name).ToList(),
            "currentQty" => sortAscending ? filteredItems.OrderBy(i => i.CurrentQuantity).ToList() : filteredItems.OrderByDescending(i => i.CurrentQuantity).ToList(),
            "expires" => sortAscending ? filteredItems.OrderBy(i => i.OutOfStockDate ?? DateTime.MaxValue).ToList() : filteredItems.OrderByDescending(i => i.OutOfStockDate ?? DateTime.MinValue).ToList(),
            "lastUpdated" => sortAscending ? filteredItems.OrderBy(i => i.LastOrderDate ?? DateTime.MaxValue).ToList() : filteredItems.OrderByDescending(i => i.LastOrderDate ?? DateTime.MinValue).ToList(),
            "price" => sortAscending ? filteredItems.OrderBy(i => i.Price).ToList() : filteredItems.OrderByDescending(i => i.Price).ToList(),
            _ => filteredItems
        };
    }

    private string GetCategoryClass(string category)
    {
        return category switch
        {
            "Grains & Pasta" => "category-grains",
            "Dairy" => "category-dairy",
            "Oils & Sauces" => "category-oils",
            "Vegetables" => "category-vegetables",
            "Meat & Poultry" => "category-meat",
            _ => "category-default"
        };
    }

    private string GetLocation(int id) => "-"; // location is now the page itself

    private bool IsPageSelected => pagedItems.Count > 0 && pagedItems.All(i => selectedIds.Contains(i.Id));

    private void ToggleSelection(int id, ChangeEventArgs args)
    {
        var isChecked = args.Value is bool boolValue && boolValue;
        if (!isChecked && args.Value is string textValue)
        {
            bool.TryParse(textValue, out isChecked);
        }

        if (isChecked)
        {
            selectedIds.Add(id);
        }
        else
        {
            selectedIds.Remove(id);
        }
    }

    private void ToggleSelectAll(ChangeEventArgs args)
    {
        var isChecked = args.Value is bool boolValue && boolValue;
        if (!isChecked && args.Value is string textValue)
        {
            bool.TryParse(textValue, out isChecked);
        }

        if (isChecked)
        {
            foreach (var item in pagedItems)
            {
                selectedIds.Add(item.Id);
            }
        }
        else
        {
            foreach (var item in pagedItems)
            {
                selectedIds.Remove(item.Id);
            }
        }
    }

    private void UpdatePagination()
    {
        totalPages = Math.Max(1, (int)Math.Ceiling(filteredItems.Count / (double)pageSize));
        currentPage = Math.Min(currentPage, totalPages);
        pagedItems = filteredItems
            .Skip((currentPage - 1) * pageSize)
            .Take(pageSize)
            .ToList();

        pageButtons = BuildPageButtons();
    }

    private List<int> BuildPageButtons()
    {
        var buttons = new List<int>();
        if (totalPages <= 1)
        {
            buttons.Add(1);
            return buttons;
        }

        if (totalPages <= 5)
        {
            for (var i = 1; i <= totalPages; i++)
            {
                buttons.Add(i);
            }
            return buttons;
        }

        buttons.Add(1);

        if (currentPage > 3)
        {
            buttons.Add(-1);
        }

        var start = Math.Max(2, currentPage - 1);
        var end = Math.Min(totalPages - 1, currentPage + 1);
        for (var i = start; i <= end; i++)
        {
            buttons.Add(i);
        }

        if (currentPage < totalPages - 2)
        {
            buttons.Add(-1);
        }

        buttons.Add(totalPages);
        return buttons;
    }

    private void GoToPage(int page)
    {
        currentPage = page;
        UpdatePagination();
    }

    private void PreviousPage()
    {
        if (currentPage > 1)
        {
            currentPage--;
            UpdatePagination();
        }
    }

    private void NextPage()
    {
        if (currentPage < totalPages)
        {
            currentPage++;
            UpdatePagination();
        }
    }

    private int GetStartIndex()
    {
        if (filteredItems.Count == 0)
        {
            return 0;
        }

        return ((currentPage - 1) * pageSize) + 1;
    }

    private int GetEndIndex()
    {
        return Math.Min(currentPage * pageSize, filteredItems.Count);
    }

    private void ShowAddItemModal()
    {
        editingItem = null;
        modalItem = new InventoryItemDTO();
        modalUnitId = 0;
        modalVendorId = 0;
        showModal = true;
    }

    private void EditItem(InventoryItemDTO item)
    {
        editingItem = item;
        modalItem = new InventoryItemDTO
        {
            Id = item.Id,
            Name = item.Name,
            SKU = item.SKU,
            Category = item.Category,
            CurrentQuantity = item.CurrentQuantity,
            Unit = item.Unit,
            Price = item.Price,
            ReorderLevel = item.ReorderLevel,
            OutOfStockDate = item.OutOfStockDate,
            LastOrderDate = item.LastOrderDate,
            Notes = item.Notes
        };
        // Find the unit by name to restore the dropdown selection
        modalUnitId = availableUnits.FirstOrDefault(u => u.Name == item.Unit)?.Id ?? 0;
        modalVendorId = item.VendorId ?? 0;
        showModal = true;
    }

    private async Task SaveItem()
    {
        try
        {
            if (editingItem != null)
            {
                // Update existing
                modalItem.IsLowStock = modalItem.CurrentQuantity <= modalItem.ReorderLevel && modalItem.CurrentQuantity > 0;
                var updated = await InventoryService.UpdateItemAsync(modalItem);
                if (updated is not null)
                {
                    var idx = inventoryItems.FindIndex(i => i.Id == updated.Id);
                    if (idx >= 0) inventoryItems[idx] = updated;
                }
            }
            else
            {
                // Create new
                var dto = new CreateIngredientDTO
                {
                    Name = modalItem.Name,
                    SKU = modalItem.SKU,
                    Category = modalItem.Category,
                    CurrentQuantity = modalItem.CurrentQuantity,
                    Price = modalItem.Price,
                    ReorderLevel = modalItem.ReorderLevel,
                    UnitId = modalUnitId > 0 ? modalUnitId : 1,
                    LocationId = LocationId,
                    VendorId = modalVendorId > 0 ? modalVendorId : null
                };
                var created = await InventoryService.AddItemAsync(dto);
                inventoryItems.Add(created);
            }

            // Refresh categories from DB in case a new one was entered
            categories = await InventoryService.GetCategoriesByLocationAsync(LocationId);

            CloseModal();
            FilterItems();
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Failed to save item: {ex}");
        }
    }

    private void CloseModal()
    {
        showModal = false;
        modalItem = new();
        editingItem = null;
        modalUnitId = 0;
        modalVendorId = 0;
    }

    private async Task OrderItem(InventoryItemDTO item)
    {
        await JSRuntime.InvokeVoidAsync("alert", $"Ordering {item.Name} coming soon.");
    }

    private async Task DeleteItem(InventoryItemDTO item)
    {
        if (!await JSRuntime.InvokeAsync<bool>("confirm", $"Are you sure you want to delete {item.Name}?"))
        {
            return;
        }
        await InventoryService.DeleteItemAsync(item.Id);
        inventoryItems.Remove(item);
        FilterItems();
    }

    private async Task ExportInventory()
    {
        await JSRuntime.InvokeVoidAsync("alert", "Export coming soon.");
    }

    private async Task RefreshInventory()
    {
        // If the user switched locations in the header, navigate to the correct page
        var currentLocId = LocationState.CurrentLocation?.Id;
        if (currentLocId.HasValue && currentLocId.Value != LocationId)
        {
            Nav.NavigateTo($"/inventory-management/{currentLocId.Value}");
            return;
        }

        await LoadInventoryData();
        locationVendors = await VendorService.GetVendorsByLocationAsync(LocationId);
    }

    private void ToggleQuickFilter()
    {
        stockStatus = stockStatus == "low" ? "" : "low";
        FilterItems();
    }

    private string SearchTerm
    {
        get => searchTerm;
        set
        {
            searchTerm = value;
            FilterItems();
        }
    }

    private string SelectedCategory
    {
        get => selectedCategory;
        set
        {
            selectedCategory = value;
            FilterItems();
        }
    }

    private string StockStatus
    {
        get => stockStatus;
        set
        {
            stockStatus = value;
            FilterItems();
        }
    }

    [Inject]
    private IJSRuntime JSRuntime { get; set; } = default!;

}
