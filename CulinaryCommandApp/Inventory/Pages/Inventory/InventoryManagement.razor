@page "/inventory-management"
@rendermode InteractiveServer

@using CulinaryCommand.Inventory.DTOs
@using Microsoft.JSInterop
@using CulinaryCommand.Inventory.Services.Interfaces
@using System.Threading.Tasks

<div class="inventory-container">
    <div class="inventory-header">
        <h1>Inventory</h1>
        <div class="header-actions">
            <button class="btn btn-success" @onclick="ShowAddItemModal">
                <i class="bi bi-plus-lg"></i> Add Item
            </button>
            @* <button class="btn btn-primary" @onclick="ExportInventory">
                <i class="bi bi-download"></i> Export
            </button> *@
        </div>
    </div>

    <!-- Filter Tabs -->
    <div class="filter-tabs">
        <button class="tab-btn @(activeTab == "all" ? "active" : "")" @onclick='() => SetActiveTab("all")'>
            All
        </button>
        <button class="tab-btn @(activeTab == "dry" ? "active" : "")" @onclick='() => SetActiveTab("dry")'>
            Dry Items
        </button>
        <button class="tab-btn @(activeTab == "arriving" ? "active" : "")" @onclick='() => SetActiveTab("arriving")'>
            Arriving Soon
        </button>
        <button class="tab-btn @(activeTab == "ordered" ? "active" : "")" @onclick='() => SetActiveTab("ordered")'>
            Ordered
        </button>
        <button class="btn-filter-list" @onclick="ToggleFilterPanel">
            <i class="bi bi-funnel"></i> Filter List
        </button>
    </div>

    <!-- Advanced Filter Panel -->
    @if (showFilterPanel)
    {
        <div class="filter-panel">
            <div class="filter-row">
                <div class="filter-group">
                    <label>Search</label>
                    <input type="text" class="form-control" @bind="searchTerm" @bind:event="oninput" placeholder="Search by name or SKU..." />
                </div>
                <div class="filter-group">
                    <label>Category</label>
                    <select class="form-control" @bind="selectedCategory">
                        <option value="">All Categories</option>
                        @foreach (var category in categories)
                        {
                            <option value="@category">@category</option>
                        }
                    </select>
                </div>
                <div class="filter-group">
                    <label>Stock Status</label>
                    <select class="form-control" @bind="stockStatus">
                        <option value="">All</option>
                        <option value="low">Low Stock</option>
                        <option value="out">Out of Stock</option>
                        <option value="sufficient">Sufficient</option>
                    </select>
                </div>
                <div class="filter-group">
                    <button class="btn btn-secondary" @onclick="ClearFilters">Clear Filters</button>
                </div>
            </div>
        </div>
    }

    <!-- Inventory Table -->
    <div class="inventory-table-container">
        <table class="inventory-table">
            <thead>
                <tr>
                    <th @onclick='() => SortBy("name")'>
                        Name <i class="bi bi-arrow-down-up"></i>
                    </th>
                    <th @onclick='() => SortBy("sku")'>
                        SKU <i class="bi bi-arrow-down-up"></i>
                    </th>
                    <th @onclick='() => SortBy("currentQty")'>
                        Current Qty <i class="bi bi-arrow-down-up"></i>
                    </th>
                    <th @onclick='() => SortBy("outOfStock")'>
                        Out of Stock <i class="bi bi-arrow-down-up"></i>
                    </th>
                    <th @onclick='() => SortBy("lastOrder")'>
                        Last Order <i class="bi bi-arrow-down-up"></i>
                    </th>
                    <th @onclick='() => SortBy("price")'>
                        Price <i class="bi bi-arrow-down-up"></i>
                    </th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @if (isLoading)
                {
                    <tr>
                        <td colspan="7" class="text-center py-4">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </td>
                    </tr>
                }
                else if (!filteredItems.Any())
                {
                    <tr>
                        <td colspan="7" class="text-center py-4">
                            <p class="text-muted">No items found</p>
                        </td>
                    </tr>
                }
                else
                {
                    @foreach (var item in filteredItems)
                    {
                        <tr class="@GetRowClass(item)">
                            <td>
                                <div class="item-name">
                                    @item.Name
                                    @if (item.IsLowStock)
                                    {
                                        <span class="badge bg-warning ms-2">Low</span>
                                    }
                                </div>
                            </td>
                            <td>@item.SKU</td>
                            <td>
                                <div class="qty-control">
                                    <button class="qty-btn" @onclick="() => DecrementQuantity(item)">
                                        <i class="bi bi-dash"></i>
                                    </button>
                                    <span class="qty-value">@item.CurrentQuantity @item.Unit</span>
                                    <button class="qty-btn" @onclick="() => IncrementQuantity(item)">
                                        <i class="bi bi-plus"></i>
                                    </button>
                                </div>
                            </td>
                            <td>
                                @if (item.OutOfStockDate.HasValue)
                                {
                                    <span class="@(IsDateCritical(item.OutOfStockDate.Value) ? "text-danger fw-bold" : "")">
                                        @item.OutOfStockDate.Value.ToString("MM/dd/yy")
                                        @if (IsDateCritical(item.OutOfStockDate.Value))
                                        {
                                            <i class="bi bi-exclamation-triangle-fill ms-1"></i>
                                        }
                                    </span>
                                }
                                else
                                {
                                    <span class="text-muted">-</span>
                                }
                            </td>
                            <td>
                                @if (item.LastOrderDate.HasValue)
                                {
                                    @item.LastOrderDate.Value.ToString("MM/dd/yy")
                                }
                                else
                                {
                                    <span class="text-muted">-</span>
                                }
                            </td>
                            <td>$@item.Price.ToString("F2")</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn-action" @onclick="() => EditItem(item)" title="Edit">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn-action" @onclick="() => OrderItem(item)" title="Order">
                                        <i class="bi bi-cart-plus"></i>
                                    </button>
                                    <button class="btn-action text-danger" @onclick="() => DeleteItem(item)" title="Delete">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>

    <!-- Summary Stats -->
    <div class="inventory-stats">
        <div class="stat-card">
            <div class="stat-label">Total Items</div>
            <div class="stat-value">@inventoryItems.Count</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Low Stock</div>
            <div class="stat-value text-warning">@inventoryItems.Count(i => i.IsLowStock)</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Out of Stock</div>
            <div class="stat-value text-danger">@inventoryItems.Count(i => i.CurrentQuantity <= 0)</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Total Value</div>
            <div class="stat-value">$@inventoryItems.Sum(i => i.CurrentQuantity * i.Price).ToString("F2")</div>
        </div>
    </div>
</div>

<!-- Add/Edit Item Modal -->
@if (showModal)
{
    <div class="modal-backdrop" @onclick="CloseModal"></div>
    <div class="modal-dialog-custom">
        <div class="modal-content-custom">
            <div class="modal-header-custom">
                <h3>@(editingItem == null ? "Add New Item" : "Edit Item")</h3>
                <button class="btn-close-custom" @onclick="CloseModal">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div class="modal-body-custom">
                <div class="form-group mb-3">
                    <label>Item Name</label>
                    <input type="text" class="form-control" @bind="modalItem.Name" />
                </div>
                <div class="form-group mb-3">
                    <label>SKU</label>
                    <input type="text" class="form-control" @bind="modalItem.SKU" />
                </div>
                <div class="form-group mb-3">
                    <label>Category</label>
                    <select class="form-control" @bind="modalItem.Category">
                        <option value="">Select Category</option>
                        @foreach (var category in categories)
                        {
                            <option value="@category">@category</option>
                        }
                    </select>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label>Current Quantity</label>
                            <input type="number" class="form-control" @bind="modalItem.CurrentQuantity" />
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label>Unit</label>
                            <select class="form-control" @bind="modalItem.Unit">
                                <option value="count">count</option>
                                <option value="gallons">gallons</option>
                                <option value="lbs">lbs</option>
                                <option value="oz">oz</option>
                                <option value="kg">kg</option>
                                <option value="liters">liters</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label>Price</label>
                            <input type="number" step="0.01" class="form-control" @bind="modalItem.Price" />
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label>Order limit</label>
                            <input type="number" class="form-control" @bind="modalItem.ReorderLevel" />
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer-custom">
                <button class="btn btn-secondary" @onclick="CloseModal">Cancel</button>
                <button class="btn btn-success" @onclick="SaveItem">
                    @(editingItem == null ? "Add Item" : "Save Changes")
                </button>
            </div>
        </div>
    </div>
}

@code {
    private List<InventoryItemDTO> inventoryItems = new();
    private List<InventoryItemDTO> filteredItems = new();
    private bool isLoading = true;
    private string activeTab = "all";
    private bool showFilterPanel = false;
    private string searchTerm = "";
    private string selectedCategory = "";
    private string stockStatus = "";
    private string sortColumn = "";
    private bool sortAscending = true;

    private List<string> categories = new() { "Produce", "Dairy", "Meat", "Dry Goods", "Beverages", "Condiments", "Spices" };

    private bool showModal = false;
    private InventoryItemDTO modalItem = new();
    private InventoryItemDTO? editingItem = null;

    protected override async Task OnInitializedAsync()
    {
        await LoadInventoryData();
    }

    private async Task LoadInventoryData()
    {
        isLoading = true;

        // Load real data from the inventory service instead of static mock data
        try
        {
            inventoryItems = await InventorySvc.GetAllItemsAsync();
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Failed to load inventory items: {ex}");
            inventoryItems = new List<InventoryItemDTO>();
        }

        FilterItems();
        isLoading = false;
    }

    private void SetActiveTab(string tab)
    {
        activeTab = tab;
        FilterItems();
    }

    private void ToggleFilterPanel()
    {
        showFilterPanel = !showFilterPanel;
    }

    private void FilterItems()
    {
        filteredItems = inventoryItems.Where(item =>
        {
            // Tab filter
            bool tabMatch = activeTab switch
            {
                "dry" => item.Category == "Dry Goods",
                "arriving" => item.OutOfStockDate.HasValue && item.OutOfStockDate.Value <= DateTime.Now.AddDays(7) && item.OutOfStockDate.Value >= DateTime.Now,
                "ordered" => item.LastOrderDate.HasValue && item.LastOrderDate.Value >= DateTime.Now.AddDays(-7),
                _ => true
            };

            // Search filter
            bool searchMatch = string.IsNullOrWhiteSpace(searchTerm) ||
                item.Name.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                item.SKU.Contains(searchTerm, StringComparison.OrdinalIgnoreCase);

            // Category filter
            bool categoryMatch = string.IsNullOrWhiteSpace(selectedCategory) ||
                item.Category == selectedCategory;

            // Stock status filter
            bool stockMatch = stockStatus switch
            {
                "low" => item.IsLowStock,
                "out" => item.CurrentQuantity <= 0,
                "sufficient" => !item.IsLowStock && item.CurrentQuantity > 0,
                _ => true
            };

            return tabMatch && searchMatch && categoryMatch && stockMatch;
        }).ToList();

        ApplySorting();
    }

    private void ClearFilters()
    {
        searchTerm = "";
        selectedCategory = "";
        stockStatus = "";
        FilterItems();
    }

    private void SortBy(string column)
    {
        if (sortColumn == column)
        {
            sortAscending = !sortAscending;
        }
        else
        {
            sortColumn = column;
            sortAscending = true;
        }
        ApplySorting();
    }

    private void ApplySorting()
    {
        filteredItems = sortColumn switch
        {
            "name" => sortAscending ? filteredItems.OrderBy(i => i.Name).ToList() : filteredItems.OrderByDescending(i => i.Name).ToList(),
            "sku" => sortAscending ? filteredItems.OrderBy(i => i.SKU).ToList() : filteredItems.OrderByDescending(i => i.SKU).ToList(),
            "currentQty" => sortAscending ? filteredItems.OrderBy(i => i.CurrentQuantity).ToList() : filteredItems.OrderByDescending(i => i.CurrentQuantity).ToList(),
            "outOfStock" => sortAscending ? filteredItems.OrderBy(i => i.OutOfStockDate ?? DateTime.MaxValue).ToList() : filteredItems.OrderByDescending(i => i.OutOfStockDate ?? DateTime.MinValue).ToList(),
            "lastOrder" => sortAscending ? filteredItems.OrderBy(i => i.LastOrderDate ?? DateTime.MaxValue).ToList() : filteredItems.OrderByDescending(i => i.LastOrderDate ?? DateTime.MinValue).ToList(),
            "price" => sortAscending ? filteredItems.OrderBy(i => i.Price).ToList() : filteredItems.OrderByDescending(i => i.Price).ToList(),
            _ => filteredItems
        };
    }

    private string GetRowClass(InventoryItemDTO item)
    {
        if (item.CurrentQuantity <= 0) return "row-out-of-stock";
        if (item.IsLowStock) return "row-low-stock";
        return "";
    }

    private bool IsDateCritical(DateTime date)
    {
        return date <= DateTime.Now.AddDays(3);
    }

    private async Task IncrementQuantity(InventoryItemDTO item)
    {
        item.CurrentQuantity++;
        item.IsLowStock = item.CurrentQuantity <= item.ReorderLevel;
        // TODO
        //Call service to update quantity
        StateHasChanged();
    }

    private async Task DecrementQuantity(InventoryItemDTO item)
    {
        if (item.CurrentQuantity > 0)
        {
            item.CurrentQuantity--;
            item.IsLowStock = item.CurrentQuantity <= item.ReorderLevel;
            // TODO 
            // Call service to update quantity
            StateHasChanged();
        }
    }

    private void ShowAddItemModal()
    {
        editingItem = null;
        modalItem = new InventoryItemDTO();
        showModal = true;
    }

    private void EditItem(InventoryItemDTO item)
    {
        editingItem = item;
        modalItem = new InventoryItemDTO
        {
            Id = item.Id,
            Name = item.Name,
            SKU = item.SKU,
            Category = item.Category,
            CurrentQuantity = item.CurrentQuantity,
            Unit = item.Unit,
            Price = item.Price,
            ReorderLevel = item.ReorderLevel
        };
        showModal = true;
    }

    private async Task SaveItem()
    {
        try
        {
            if (editingItem != null)
            {
                // Persist changes via service
                var updated = await InventorySvc.UpdateItemAsync(modalItem);
                if (updated != null)
                {
                    var idx = inventoryItems.FindIndex(i => i.Id == updated.Id);
                    if (idx >= 0)
                        inventoryItems[idx] = updated;
                    else
                        inventoryItems.Add(updated);

                    editingItem = inventoryItems.First(i => i.Id == updated.Id);
                }
                else
                {
                    await JSRuntime.InvokeVoidAsync("alert", "Failed to update item.");
                }
            }
            else
            {
                // Create new ingredient via service
                var dto = new CreateIngredientDTO
                {
                    Name = modalItem.Name,
                    SKU = string.IsNullOrWhiteSpace(modalItem.SKU) ? null : modalItem.SKU,
                    CurrentQuantity = modalItem.CurrentQuantity,
                    Price = modalItem.Price,
                    Category = modalItem.Category,
                    ReorderLevel = modalItem.ReorderLevel,
                    UnitId = 1 // TODO: wire a real unit selector; use sensible default for now
                };

                var created = await InventorySvc.AddItemAsync(dto);
                if (created != null)
                {
                    inventoryItems.Add(created);
                }
            }

            CloseModal();
            FilterItems();
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Failed to save item: {ex}");
        }
    }

    private void CloseModal()
    {
        showModal = false;
        modalItem = new();
        editingItem = null;
    }

    private async Task OrderItem(InventoryItemDTO item)
    {
        //TODO
        // Implement some  type of order functionality
        Console.WriteLine($"Ordering {item.Name}");
    }

    private async Task DeleteItem(InventoryItemDTO item)
    {
        if (!await JSRuntime.InvokeAsync<bool>("confirm", $"Are you sure you want to delete {item.Name}?"))
        {
            return;
        }
        try {
            var success = await InventorySvc.DeleteItemAsync(item.Id);

            if (success) {
                inventoryItems.Remove(item);
                FilterItems();
            }
            else {
                await JSRuntime.InvokeVoidAsync("alert", $"Failed to delete {item.Name}.");
            }
        }
        catch (Exception ex) {
            Console.Error.WriteLine($"Failed to delete item: {ex}");
            await JSRuntime.InvokeVoidAsync("alert", "An error occurred while deleting the item.");
        }
    }
/*
     // If needed immplement CSV/Excel export
    private void ExportInventory()
    {
        Console.WriteLine("Exporting inventory...");
    }
*/

    [Inject]
    private IJSRuntime JSRuntime { get; set; } = default!;

    [Inject]
    private IInventoryManagementService InventorySvc { get; set; } = default!;
}
