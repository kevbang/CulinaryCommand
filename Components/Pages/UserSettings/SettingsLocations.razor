@using CulinaryCommand.Services
@using CulinaryCommand.Data.Entities
@using CulinaryCommand.Models
@inject AuthService Auth
@inject ILocationService LocationService
@inject NavigationManager NavigationManager

<div class="tab-pane active">
    @if (string.IsNullOrEmpty(Specifier))
    {
        <!-- Location list / Manage -->
        <h4 class="mb-4">Manage Locations</h4>

        <div class="mb-4">
            @if (managedLocations?.Count > 0)
            {
                <div class="row g-3">
                    @foreach (Location loc in managedLocations)
                    {
                        <div class="col-sm-12 col-md-6 col-lg-4 col-xl-3">
                            <div class="card shadow-sm border-0 h-100 d-flex flex-column">
                                <div class="card-body d-flex flex-column">
                                    <div>
                                        <h5 class="card-title">@loc.Name</h5>
                                        <p class="card-text text-muted mb-2">@loc.Address</p>
                                        <small class="text-muted d-block mb-3">
                                            @loc.City, @loc.State @loc.ZipCode
                                        </small>
                                    </div>

                                    <div class="mt-auto">
                                        <div class="d-flex justify-content-between">
                                            <button class="btn btn-outline-primary btn-sm"
                                                    @onclick="() => EditLocation(loc)">
                                                <i class="fas fa-edit me-1"></i>Edit
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }

                    <div class="col-sm-12 col-md-6 col-lg-4 col-xl-3">
                        <button class="btn btn-secondary btn-sm"
                                @onclick="AddLocation">
                            <i class="bi bi-square-plus me-1"></i>Add location
                        </button>
                    </div>
                </div>
            }
            else
            {
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div class="alert alert-info mb-0">
                        You donâ€™t manage any locations yet.
                    </div>
                    <div class="mx-3">
                        <button class="btn btn-secondary btn-sm" @onclick="AddLocation">
                            <i class="bi bi-square-plus me-1"></i>Add location
                        </button>
                    </div>
                </div>
            }
        </div>
    }
    else if (Specifier == "add")
{
    <h4 class="mb-4">Create Location</h4>

    <div class="mb-3 p-3 bg-light border rounded">
        <strong>Company:</strong>
        <span class="ms-2">
            @(Auth.CurrentUser?.Company?.Name ?? "No company assigned")
        </span>
    </div>

    <EditForm Model="@locationModel" OnValidSubmit="@HandleLocationCreate">
        <DataAnnotationsValidator />

        <div class="row mb-3">
            <div class="col-md-6">
                <label for="locationName" class="form-label">Location Name</label>
                <InputText id="locationName" class="form-control"
                           @bind-Value="locationModel.Name" />
            </div>

            <div class="col-md-6">
                <label for="address" class="form-label">Street Address</label>
                <InputText id="address" class="form-control"
                           @bind-Value="locationModel.Address" />
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-4">
                <label for="city" class="form-label">City</label>
                <InputText id="city" class="form-control"
                           @bind-Value="locationModel.City" />
            </div>

            <div class="col-md-4">
                <label for="state" class="form-label">State</label>
                <InputText id="state" class="form-control"
                           @bind-Value="locationModel.State" />
            </div>

            <div class="col-md-4">
                <label for="zipcode" class="form-label">Postal Code</label>
                <InputText id="zipcode" class="form-control"
                           @bind-Value="locationModel.ZipCode" />
            </div>
        </div>

        <button type="submit" class="btn btn-success">
            <i class="bi bi-plus-circle me-2"></i>Create Location
        </button>

        <button class="btn btn-outline-secondary ms-2"
                @onclick="() => NavigationManager.NavigateTo(temp)">    @*fix later*@
            Cancel
        </button>
    </EditForm>
}
    else
    {
        <!-- Location edit form -->
        <h4 class="mb-4">Location Information</h4>

        @if (currentLocation == null)
        {
            <div class="alert alert-warning">
                Location not found.
            </div>
        }
        else
        {
            <EditForm Model="@locationModel" OnValidSubmit="@HandleLocationSubmit">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="locationName" class="form-label">Location Name</label>
                        <InputText id="locationName" class="form-control"
                                   @bind-Value="locationModel.Name"
                                   placeholder="Enter location name" />
                    </div>
                    <div class="col-md-6">
                        <label for="address" class="form-label">Address</label>
                        <InputText id="address" class="form-control"
                                   @bind-Value="locationModel.Address"
                                   placeholder="Enter an address" />
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-4">
                        <label for="city" class="form-label">City</label>
                        <InputText id="city" class="form-control"
                                   @bind-Value="locationModel.City"
                                   placeholder="Enter a city" />
                    </div>
                    <div class="col-md-4">
                        <label for="state" class="form-label">State</label>
                        <InputText id="state" class="form-control"
                                   @bind-Value="locationModel.State"
                                   placeholder="Enter a state" />
                    </div>
                    <div class="col-md-4">
                        <label for="zipcode" class="form-label">Postal Code</label>
                        <InputText id="zipcode" class="form-control"
                                   @bind-Value="locationModel.ZipCode"
                                   placeholder="Enter a postal code" />
                    </div>
                </div>

                <button type="submit" class="btn btn-success settings-btn">
                    <i class="bi bi-save me-2"></i>Save Changes
                </button>
            </EditForm>
        }
    }
</div>

@code {
    [Parameter] public string? Specifier { get; set; }

    private Location? currentLocation { get; set; }
    private List<Location> managedLocations { get; set; } = new();
    private LocationModel locationModel { get; set; } = new();
    private string temp = "/settings/locations";
    protected override async Task OnInitializedAsync()
    {
        await PopulateLocations();
        await EnsureEditModelIfNeeded();
    }

    protected override async Task OnParametersSetAsync()
    {
        // When route changes (e.g., /settings/locations/5), refresh edit model
        await EnsureEditModelIfNeeded();
    }

    private async Task PopulateLocations()
    {
        if (Auth.UserId is int userId)
        {
            managedLocations = await LocationService.GetLocationsByManagerAsync(userId);
        }
        else
        {
            managedLocations = new List<Location>();
        }
        StateHasChanged();
    }

    private async Task EnsureEditModelIfNeeded()
    {
        if (!string.IsNullOrEmpty(Specifier) && Specifier != "add")
        {
            if (int.TryParse(Specifier, out var id))
            {
                await LoadLocation(id);
            }
        }
    }

    private async Task LoadLocation(int locationId)
    {
        currentLocation = await LocationService.GetLocationByIdAsync(locationId);

        if (currentLocation != null)
        {
            locationModel = new LocationModel
            {
                Id           = currentLocation.Id,
                Name         = currentLocation.Name,
                Address      = currentLocation.Address,
                City         = currentLocation.City,
                State        = currentLocation.State,
                ZipCode      = currentLocation.ZipCode,
                MarginEdgeKey = currentLocation.MarginEdgeKey
            };
        }
        else
        {
            locationModel = new LocationModel();
        }
    }

    private void AddLocation()
    {
        locationModel = new LocationModel();
        NavigationManager.NavigateTo("/settings/locations/add");
    }

    private async Task HandleLocationCreate()
    {
        if (Auth.UserId == null)
            return;

        var newLocation = new Location
        {
            Name = locationModel.Name,
            Address = locationModel.Address,
            City = locationModel.City,
            State = locationModel.State,
            ZipCode = locationModel.ZipCode,
        };

        var created = await LocationService.CreateLocationAsync(newLocation, Auth.UserId.Value);

        if (created is null)
        {
            Console.WriteLine("Failed to create location.");
            return;
        }

        // ðŸ”„ Refresh what the user can see (Auth + localStorage + cc_locations)
        await LocationService.LoadAndPersistLocationsAsync(Auth.UserId.Value);

        // Optionally navigate back to the list view
        NavigationManager.NavigateTo("/settings/locations");
    }

    private async Task HandleLocationSubmit()
    {
        if (currentLocation == null)
        {
            return;
        }

        // TODO: implement update API in LocationService
        Console.WriteLine($"Location updated: {locationModel.Name}");
        NavigationManager.NavigateTo("/settings/locations");
    }

    private void EditLocation(Location loc)
    {
        if (loc == null)
            return;

        NavigationManager.NavigateTo($"/settings/locations/{loc.Id}");
    }
}