stages:
    - frontend-verify
    - build
    - deploy

variables:
  ConnectionStrings__DefaultConnection: "Server=${DB_SERVER};Port=3306;Database=${DB_NAME};User=${DB_USER};Password=${DB_PASSWORD};SslMode=None;TreatTinyAsBoolean=false"

verify-frontend:
    stage: frontend-verify
    rules:
      - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "main"'
    tags:
        - frontend
    script:
        - echo "hello frontend!"

build-app:
  stage: build
  tags:
    - frontend
  image: mcr.microsoft.com/dotnet/sdk:9.0
  only:
  - main
  script:
    - echo "Building CulinaryCommand..."
    - dotnet --version # debugging purposes
    # Verify connection string is set (will show first 50 chars only for security)
    - echo "Connection string loaded:" ${ConnectionStrings__DefaultConnection:0:50}...
    - dotnet clean CulinaryCommand.csproj
    - dotnet restore CulinaryCommand.csproj
    - dotnet build CulinaryCommand.csproj --configuration Release
    - dotnet publish CulinaryCommand.csproj -c Release -o publish-temp/
  artifacts:
    paths:
      - publish-temp/
    expire_in: 1 hour 


# deploy to IIS
deploy-app:
  stage: deploy
  tags:
   - frontend
  only:
   - main
  script:
   # this stage depoloys the built app to the VM running IIS (Microsfoft Internet Information Services)
   # IIS is Microsoft's web server used to host and serve web applications
   # IIS hosts CulinaryCommand in the app pool, which is the container that isolates the app
   # The app pool is pointing to the folder 'C:\Users\vm-user\CulinaryCommand\publish\' on the VM
   - echo "Deploying to IIS..."
   # powershell script:
   #  - stops Microsoft IIS app pool
   #  - kills extra worker processes
   #  - copies the new publish output on the runner to the \publish\ folder on the VM
   #  - restarts the Microsoft IIS app pool, loads latest commit
   - powershell -NoProfile -Command "
     Import-Module WebAdministration;
     Write-Host 'Stopping app pool...';
     Stop-WebAppPool -Name 'CulinaryCommand' -ErrorAction SilentlyContinue;
     Start-Sleep -Seconds 30;
     Write-Host 'Force killing worker processes...';
     Get-Process -Name 'w3wp' -ErrorAction SilentlyContinue | Stop-Process -Force -ErrorAction SilentlyContinue;
     Start-Sleep -Seconds 10;
     Get-Process -Name 'w3wp' -ErrorAction SilentlyContinue | Stop-Process -Force -ErrorAction SilentlyContinue;
     Start-Sleep -Seconds 5;
     Write-Host 'Copying files...';
     Copy-Item -Recurse -Force 'publish-temp\*' 'C:\Users\vm-user\CulinaryCommand\publish\';

     Write-Host 'Updating connection string in appsettings.json...';
     $connString = \"Server=${DB_SERVER};Port=3306;Database=${DB_NAME};User=${DB_USER};Password=${DB_PASSWORD};SslMode=None;TreatTinyAsBoolean=false\";
     $configPath = 'C:\Users\vm-user\CulinaryCommand\publish\appsettings.json';
     $appSettings = Get-Content $configPath | ConvertFrom-Json;
     $appSettings.ConnectionStrings.DefaultConnection = $connString;
     $appSettings | ConvertTo-Json -Depth 10 | Set-Content $configPath;
     Write-Host 'Connection string updated successfully';

     Write-Host 'Starting app pool...';
     Start-WebAppPool -Name 'CulinaryCommand';
     Write-Host 'Deployment complete!';
     "
  dependencies:
   - build-app